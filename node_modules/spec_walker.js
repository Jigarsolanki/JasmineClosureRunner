var sys = require('sys'),
  events = require('events'),
  walk = require('walk');

SpecWalker = function() {
  events.EventEmitter.call(this);
};
sys.inherits(SpecWalker, events.EventEmitter);

SpecWalker.prototype.generateJson = function (path) {

  var walker, tree, baselimit;

  path = path.lastIndexOf('/') === (path.length - 1) ?
  path.substring(0, path.length - 1): path;
  baselimit = path.lastIndexOf('/') + 1;
  tree = {};
  jsonRoot = path.substring(baselimit);
  tree[jsonRoot] = {};

  getTreeRoot = function(currentPath) {

    var treeRoot;

    if(currentPath === path) {
      return tree[path];
    } else {
      var paths = currentPath.split('/');
      treeRoot = tree;
      for(var i =0; i < paths.length; i++) {
        treeRoot = treeRoot[paths[i]];
      }
      return treeRoot;
    }
  };

  walker = walk.walk(path, { followLinks: false });
  walker.on("directories", function (root, dirStatsArray, next) {
    var treeRoot;
    treeRoot = getTreeRoot(root.substring(baselimit));
    for(var i=0; i< dirStatsArray.length; i++) {
      treeRoot[dirStatsArray[i].name] = {};
    }
    next();
  });

  walker.on("file", function (root, dirStatsArray, next) {
    var treeRoot;
    treeRoot = getTreeRoot(root.substring(baselimit));
    if( dirStatsArray.name.substr(-8) === "_spec.js" ) {
      treeRoot[dirStatsArray.name] = {};
    }
    next();
  });

  walker.on('end', function() {
    this.emit('finished', tree);
  });

  return walker;
};


SpecWalker.prototype.getSpecFilesByRootDir = function (namespace) {

  var files, isASpecFile;

  files = [];
  //TODO: make this compatible with config.json
  namespace = './static/external/spec/' + namespace;
  isASpecFile = function (path) {
    return path.substr(-8) === "_spec.js";
  };

  walker = walk.walk(namespace, { followLinks: false });
  walker.on("file", function (root, dirStatsArray, next) {
    if(isASpecFile(dirStatsArray.name)) {
      files.push(root + "/" + dirStatsArray.name);
    }
    next();
  });
  walker.on('end', function() {
    this.emit('finished', files);
  });
  return walker;
};


exports.SpecWalker = SpecWalker;
